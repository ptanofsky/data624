---
title: "DATA 624 Assignment 7"
subtitle: "CUNY Fall 2021"
author: "Philip Tanofsky"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r warning=F, message=F}
# Import required R libraries
library(AppliedPredictiveModeling)
library(caret)
library(tidyverse)
library(pls)
```

# Exercise 6.2

Developing a model to predict permeability (see Sect. 1.4) could save significant resources for a pharmaceutical company, while at the same time more rapidly identifying molecules that have a sufficient permeability to become a drug:

## Section a

Start R and use these commands to load the data:

```{r warning=F, message=F}
data(permeability)
data(fingerprints)

fp_data <- as.data.frame(fingerprints)

perm_data <- as.data.frame(permeability)
fp_data <- as.data.frame(fingerprints)

#str(perm_data)
#str(fp_data)

#summary(fp_data)
#head(fp_data)
dim(fp_data)

#summary(perm_data)
#head(perm_data)
dim(perm_data)
```


165 observations in `fingerprints` dataset with 1107 features. 165 observations (predictions) in `permeability` dataset with 1 feature, the prediction.

The matrix `fingerprints` contains the 1,107 binary molecular predictors for the 165 compounds, while permeability contains `permeability` response.

## Section b

The fingerprint predictors indicate the presence or absence of substructures of a molecule and are often sparse meaning that relatively few of the molecules contain each substructure. Filter out the predictors that have low frequencies using the `nearZeroVar` function from the `caret` package. How many predictors are left for modeling?

```{r  warning=F, message=F}
nzv_cols <- nearZeroVar(fp_data)
length(nzv_cols)

# From: https://stackoverflow.com/questions/28043393/nearzerovar-function-in-caret
if(length(nzv_cols) > 0) fp_data <- fp_data[, -nzv_cols]

dim(fp_data)

fp_data <- fp_data %>%
  mutate_if(is.numeric,as.factor)

# Add the outcome variable to the predictors dataset
fp_data$Permeability <- perm_data$permeability

dim(fp_data)

#str(fp_data)
```

719 features with near zero variance. thus 388 features remaining.

## Section c

Split the data into a training and a test set, pre-process the data, and tune a PLS model. How many latent variables are optimal and what is the corresponding re-sampled estimate of $R^2$?

```{r plsFit, warning=F, message=F}
# From textbook: Prior to performing PLS, the predictors should be centered and scaled,
# PLS has one tuning parameter: the number of components to retain.

# Set the random number seed so we can reproduce the results
set.seed(8675309)

#summary(fp_data)

trainingRows <- createDataPartition(fp_data$Permeability, p = .80, list=FALSE)

# Training set
training_data <- fp_data[trainingRows, ]

# Test set
test_data <- fp_data[-trainingRows, ]

# Initial model following example from book
plsFit <- plsr(Permeability ~ ., data=training_data)
plsFit
```

```{r warning=F, message=F}
# Training pls model based on book example
ctrl <- trainControl(method = "cv", number = 10)

# No metric parameter defaults to RMSE
plsTune <- train(Permeability ~ .,
                data = training_data,
                method = "pls",
                metric = "Rsquared",
                tuneLength = 20,
                trControl = ctrl,
                preProc = c("center", "scale")) 

plsTune

ggplot(plsTune)
```

## Section d

Predict the response for the test set. What is the test set estimate of $R^2$?

```{r warning=F, message=F}
preds_test <- predict(plsTune, test_data) 
postResample(pred=preds_test, obs=test_data$Permeability)
```

## Section e

Try building other models discussed in this chapter. Do any have better predictive performance?

ridge-regression
lasso
elastic net

```{r warning=F, message=F}
# Ridge regression
#ridgeRegFit <-train(solTrainXtrans, solTrainY, + + + + + +
#method = "ridge",
## Fir the model over many penalty values tuneGrid = ridgeGrid, trControl = ctrl,
## put the predictors on the same scale preProc = c("center", "scale"))

```

## Section f

Would you recommend any of your models to replace the permeability laboratory experiment?

```{r warning=F, message=F}

```

-----

# Exercise 6.3

A chemical manufacturing process for a pharmaceutical product was discussed in Sect. 1.4. In this problem, the objective is to understand the relationship between biological measurements of the raw materials (predictors), measurements of the manufacturing process (predictors), and the response of product yield. Biological predictors cannot be changed but can be used to assess the quality of the raw material before processing. On the other hand, manufacturing process predictors can be changed in the manufacturing process. Improving product yield by 1% will boost revenue by approximately one hundred thousand dollars per batch:

## Section a

Start R and use these commands to load the data:

```{r warning=F, message=F}
data(ChemicalManufacturingProcess)

#str(ChemicalManufacturingProcess)
#summary(ChemicalManufacturingProcess)
dim(ChemicalManufacturingProcess)
#head(ChemicalManufacturingProcess)
cmp_data <- as.data.frame(ChemicalManufacturingProcess)

#head(cmp_data)
```

The matrix `processPredictors` contains the 57 predictors (12 describing the input biological material and 45 describing the process predictors) for the 176 manufacturing runs. yield contains the percent yield for each run.

Not sure what `processPredictors` actually refers to, but it's not an object from the `AppliedPredictiveModeling` library.

## Section b

A small percentage of cells in the predictor set contain missing values. Use an imputation function to fill in these missing values (e.g., see Sect. 3.8).

```{r warning=F, message=F}
# Let's identify the missing values first using vis_miss
library(naniar)
library(RANN)
vis_miss(cmp_data)

# Let's try to impute using preprocess function
# And make sure not to transform the 'Yield' column which is the result
cmp_preprocess_data <- preProcess(cmp_data[, -c(1)], method="knnImpute")

cmp_full_data <- predict(cmp_preprocess_data, cmp_data[, -c(1)])
cmp_full_data$Yield <- cmp_data$Yield
vis_miss(cmp_full_data)
# Note: By using knnImpute, all the data has been centered and scaled
```

Above plot confirms no missing values in the predictor columns after applying the kNN imputation approach based on the `preProcess` function.

## Section c

Split the data into a training and a test set, pre-process the data, and tune a model of your choice from this chapter. What is the optimal value of the performance metric?

```{r warning=F, message=F}
# Set the random number seed so we can reproduce the results
# Jenny, I got your number
set.seed(8675309)

nzv_cols <- nearZeroVar(cmp_full_data)
length(nzv_cols)
# From: https://stackoverflow.com/questions/28043393/nearzerovar-function-in-caret
if(length(nzv_cols) > 0) cmp_full_data <- cmp_full_data[, -nzv_cols]
dim(cmp_full_data)

trainingRows <- createDataPartition(cmp_full_data$Yield, p = .80, list=FALSE)

# Training set
training_data <- cmp_full_data[trainingRows, ]

# Test set
test_data <- cmp_full_data[-trainingRows, ]
```

## Section d

Predict the response for the test set. What is the value of the performance metric and how does this compare with the resampled performance metric on the training set?

```{r warning=F, message=F}

```

## Section e

Which predictors are most important in the model you have trained? Do either the biological or process predictors dominate the list?

```{r warning=F, message=F}

```

## Section f

Explore the relationships between each of the top predictors and the re-sponse. How could this information be helpful in improving yield in future runs of the manufacturing process?

```{r warning=F, message=F}

```



```{r warning=F, message=F}

```

```{r warning=F, message=F}

```

```{r warning=F, message=F}

```

