---
title: "DATA 624 Assignment 10"
subtitle: "CUNY Fall 2021"
author: "Philip Tanofsky"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: false
    theme: united
    highlight: tango
---

# Exercise

Imagine 10000 receipts sitting on your table. Each receipt represents a transaction with items that were purchased. The receipt is a representation of stuff that went into a customer's basket - and therefore 'Market Basket Analysis'.

That is exactly what the Groceries Data Set contains: a collection of receipts with each line representing 1 receipt and the items purchased. Each line is called a transaction and each column in a row represents an item. The data set is attached.

Your assignment is to use R to mine the data for association rules. You should report support, confidence and lift and your top 10 rules by lift.

**Extra credit:** do a simple cluster analysis on the data as well. Use whichever packages you like. Due May 3 before midnight.

```{r warning=F, message=F}
# Import required R libraries
#library(tidyverse)
library(arules)
library(arulesViz)

# Set seed for assignment
set.seed(200)
```

The `arules` package (<https://www.rdocumentation.org/packages/arules/versions/1.7-1>) "provides the infrastructure for representing, manipulating and analyzing transaction data and patterns using frequent itemsets and association rules." The `arules` library contains the data structure definitions and mining algorithms - APRIORI and ECLAT.

The `arulesViz` library provides visualizations for the association rules.

Is this making life easier for me?

# Exploratory Data Analysis

Using the example provided at <http://r-statistics.co/Association-Mining-With-R.html>, I read in the provided CSV file as transactions objects per the `arules` package.

```{r warning=F, message=F}
# http://r-statistics.co/Association-Mining-With-R.html
grocery_ds <- read.transactions("GroceryDataSet.csv", sep=",")
class(grocery_ds)
```

The `class()` function confirms the `grocery_ds` object is transactions from the `arules` package.

```{r warning=F, message=F}
summary(grocery_ds)
```

Summary of the grocery data set indicates 9835 rows, or individual receipts defined as transactions, with a total of 169 columns, or unique items. The most frequent items are whole milk, other vegetables, rolls/buns, soda, and yogurt. The median number of items per transaction is 3 with an average number of 4.4 items per transaction. The minimum is 1, which is expected, and the maximum items per a transaction is 32.

```{r warning=F, message=F}
size(head(grocery_ds))
LIST(head(grocery_ds, 3))
inspect(head(grocery_ds, 3))
```

The `size()` function confirms the item count per transaction and the `LIST()` function confirms the data object meets expectations, the first three transactions are displayed. The results above match the raw CSV file. The `inspect()` functions appears to behave the same as `LIST()` but perhaps a cleaner output presentation.

## Support

```{r warning=F, message=F}
# calculates 'support' of the frequent items in the dataset
support_val <- 0.07
frequentItems <- eclat(grocery_ds, parameter = list(supp=support_val, maxlen=15))
```

The `eclat()` function "finds frequent item sets with the Eclat algorithm, which carries out a depth first search on the subset lattice and determines the support of item sets by intersecting transaction lists." (<https://borgelt.net/eclat.html>) The parameter `supp` represents $support$ which is defined as the proportion of transactions in the dataset which contain the item. The parameter value is the minimum threshold.

```{r warning=F, message=F}
inspect(frequentItems)
```

With a support value of `r support_val`, the output reports the above 19 results which indicates only one pair of items appear at that proportion of the time, whole milk and other vegetables. The result makes initial sense given those two items are the most frequent individually and are grocery staples.

```{r warning=F, message=F}
itemFrequencyPlot(grocery_ds, topN=10, type="absolute", main="Item Frequency") # plot frequent items
```

The plot above displays a count of the 10 most frequent items with whole milk and other vegetables occurring most often, matching the results of the `summary()` function above.

# Generate Association Rules

## Confidence

```{r warning=F, message=F}
# Define minimum support
# Define minimum confidence (increase to get stronger rules)
# Increase maxlen to get longer rules
supp_val <- 0.001
conf_val <- 0.95
rules <- apriori(grocery_ds, parameter=list(supp=supp_val, conf=conf_val, maxlen=5))
rules_conf <- sort(rules, by="confidence", decreasing=TRUE)
```

The `apriori()` function "finds association rules and frequent item sets with the Apriori algorithm, which carries out a breadth first search on the subset lattice and determines the support of item sets by subset tests." (<https://borgelt.net/apriori.html>)

```{r warning=F, message=F}
inspect(head(rules_conf, 10))
```

## Lift

```{r warning=F, message=F}
rules_lift <- sort(rules, by="lift", decreasing=TRUE)
inspect(head(rules_lift, 10))
```

## Redundant Rules

```{r warning=F, message=F}
subsetRules <- which(colSums(is.subset(rules, rules)) > 1) # get subset rules in vector
length(subsetRules)  #> 3913
rules <- rules[-subsetRules] # remove subset rules.
```

To find what factors influence purchase of product X

```{r warning=F, message=F, eval=F}
# EVAL=F
# How to find rules related to given item/s?
rules <- apriori(data=grocery_ds, parameter=list(supp=-.001, conf=0.08), appearance = list(default="lhs",rhs="whole milk"), control=list(verbose=F)) # get rules that lead to buying 'whole milk'
rules_conf <- sort(rules, by="confidence", decreasing=TRUE) # 'high-confidence' rules
inspect(head(rules_conf))

```

To find out what products were purchased after/along with product X

```{r warning=F, message=F, eval=F}
# EVAL=F
rules <- apriori(data=grocery_ds, parameter=list(supp=0.001, confo=0.15, minlen=2), appearance=list(default="rhs",lhs="whole milk"), control=list(verbose=F)) # those who bought 'milk' also bought ...
rules_conf <- sort(rules, by="confidence", decreasing=TRUE) # high-confidence rules
inspect(head(rules_conf))
```

```{r warning=F, message=F}
# https://cran.r-project.org/web/packages/arulesViz/vignettes/arulesViz.pdf
options(digits = 2)
set.seed(1234)
summary(grocery_ds)
```

```{r warning=F, message=F}
rules <- apriori(grocery_ds, parameter=list(support=0.001, confidence=0.5))
```

```{r warning=F, message=F}
rules
```

```{r warning=F, message=F}
plot(rules)
```

```{r warning=F, message=F}
head(quality(rules))
```

```{r warning=F, message=F}
plot(rules, measure=c("support", "lift"), shading="confidence")
```

```{r warning=F, message=F}
plot(rules, method="two-key plot")
```

```{r warning=F, message=F, fig.height=8}
plot(rules, method="grouped", control = list(k = 10))
```

```{r warning=F, message=F}
subrules2 <- head(rules, n=10, by="lift")
plot(subrules2, method="graph")
```

#30#

```{r warning=F, message=F}

```

```{r warning=F, message=F}

```

```{r warning=F, message=F}

```

```{r warning=F, message=F}

```
